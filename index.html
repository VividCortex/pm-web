<!DOCTYPE html>
<html ng-app="psApp">
  <head>
    <title>Process manager</title>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <!-- Bootstrap -->
    <link href='css/bootstrap.min.css' rel='stylesheet'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src='https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js'></script>
    <script src='https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js'></script>
    <![endif]-->
    <script src='https://ajax.googleapis.com/ajax/libs/angularjs/1.2.7/angular.min.js'></script>
    <style type='text/css'>
    .container {
      max-width: 90%;
      width: 60em;
    }
    </style>

    <script>
    var psApp = angular.module('psApp', []);
    psApp
    .controller("ProcessListCtrl", function($scope, $http, $timeout) {
      (function tick() {
        getProcesses($http)
        .success(function(data, status, headers, config) {
          $scope.processes = data.procs;
          $scope.serverTime = Date.parse(data.serverTime);
          for(i in $scope.processes) {
            $scope.processes[i].statusTime = Date.parse($scope.processes[i].statusTime);
            $scope.processes[i].procTime = Date.parse($scope.processes[i].procTime);
            $scope.processes[i].runningStatusTime = ($scope.serverTime - $scope.processes[i].statusTime)/1000.0;
            $scope.processes[i].runningProcTime = ($scope.serverTime - $scope.processes[i].procTime)/1000.0;
          }

          // Sort the array by total run time
          $scope.processes.sort(function(a, b) {
            return b.runningProcTime - a.runningProcTime;
          });
        })
        .error(function() {
          $scope.processes = [];
        })
        $timeout(tick, 1000);
      })();

      $scope.cancel = function(process) {
          $http({method: "delete", url:"http://localhost:8081/procs/"+process.id, data:{message: "Cancel message"}});
      };

    });

    function getProcesses($http) {
      return $http.get('http://localhost:8081/procs/')
    }

    </script>
  </head>
  <body>
    <div class='container'>
    <div class='page-header'>
      <h1>Process manager</h1>
    </div>

    <table class='table table-condensed' ng-controller='ProcessListCtrl'>
      <colgroup>
        <col span='1' style='width: 30%'>
        <col span='1' style='width: 20%'>
        <col span='1' style='width: 25%'>
        <col span='1' style='width: 25%'>
      </colgroup>
      <tr>
        <th>Process ID</th>
        <th>Status</th>
        <th>Running time (sec)</th>
        <th>Manage</th>
      </tr>
      <tr ng-repeat="process in processes">
        <td>{{process.id}}</td>
        <td>{{process.status}}</td>
        <td>{{process.runningProcTime}}</td>
        <td>
          <button type="button" class="btn btn-danger" ng-click="cancel(process)">Cancel</button>
        </td>
      </tr>
    </table>

    </div>
  </body>
</html>
